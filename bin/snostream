#!/usr/bin/env python

import sys
import snostream.server
from snostream.stream import EventPickleFile, RATRootFile, ZDABFile, OrcaJSONStream
from snostream.store import MemoryStore
from snostream.apps.websnoed import EventViewerNamespace

if __name__ == '__main__':
    # event source
    if sys.argv[1].endswith('.pickle'):
        f = EventPickleFile(sys.argv[1], EventViewerNamespace.broadcast_event)
        EventViewerNamespace.event_getter = f.get

    elif sys.argv[1].endswith('.root'):    
        f = RATRootFile(sys.argv[1], EventViewerNamespace.broadcast_event)
        EventViewerNamespace.event_getter = f.get

    elif sys.argv[1].endswith('.zdab'):
        f = ZDABFile(sys.argv[1], EventViewerNamespace.broadcast_event)

    else:
        print 'Unknown file format'
        sys.exit(1)

    f.start()

    # data storage backend
    store = MemoryStore()

    # other data sources
    orca_json = OrcaJSONStream('tcp://localhost:5028', store.set)
    orca_json.start()

    # start web/socket server
    snostream.server.serve()

    # wait for threads to exit
    f.join()
    orca_json.join()

